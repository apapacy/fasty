#!/usr/bin/env node
/*jshint -W097, -W033, node: true, esversion: 6 */
"use strict"

var argv = require('yargs').argv
var colors = require('colors')
var request = require('request')
var _ = require('lodash')
var chokidar = require('chokidar')
const notifier = require('node-notifier')
var yaml = require('js-yaml')

var fs = require('fs')
var dirname = process.cwd()
if(!fs.existsSync(dirname + '/.tokens.yml')) {
  console.log("Please configure a .tokens.yml file for tokens".red)
  process.exit()
}

var tokens = yaml.safeLoad(fs.readFileSync(dirname + '/.tokens.yml', 'utf8'))

var check_json = function(json, folder, fullname, api) {
  _.each(json, function(v, k) {
    var pathname = 'fs/' + folder + '/' + k
    if(!fs.existsSync(pathname)) fs.mkdirSync(pathname)
    _.each(v, function (obj) {
      var endpathname = pathname
      console.log(obj)
      obj.name = _.first(_.compact([obj.name, obj.title, obj.slug]))
      if (obj.name) {
        if(obj.path) {
          var recursive_path = pathname
          _.each(obj.path, function(pa) {
            if(pa != "Root") {
              recursive_path += '/' + pa
              if(!fs.existsSync(recursive_path)) fs.mkdirSync(recursive_path)
            }
          })
          endpathname = recursive_path + '/' + obj.name
        } else {
          endpathname = pathname + '/' + obj.name
        }
        if(!fs.existsSync(endpathname)) fs.mkdirSync(endpathname)
      }

      var header = obj.locked_by ? '@lock' : ''
      header += "#FASTY " + obj.id

      if (k == "layouts") {
        fs.writeFileSync(endpathname + '/' + obj.name + '.html', header + " html\n" + obj.html)
        fs.writeFileSync(endpathname + '/' + obj.name + '.scss', header + " scss\n" + obj.scss)
        fs.writeFileSync(endpathname + '/' + obj.name + '.js', header + " js\n" + obj.js)
      }
      if (k == "components") {
        console.log(obj.path)
        fs.writeFileSync(endpathname + '/' + obj.name + '.html', header + " html\n" + obj.html)
      }
      if (k == "partials") {
        console.log(obj.path)
        fs.writeFileSync(endpathname + '/' + obj.name + '.html', header + " html\n" + obj.html)
      }
      if (k == "aqls") {
        fs.writeFileSync(endpathname + '/' + obj.name + '.aql', header + " aql\n" + obj.aql)
      }
      if (k == "apis") {
        header = "#FASTY " + obj.api.id
        endpathname = pathname + '/' + obj.api.name
        if(!fs.existsSync(endpathname)) fs.mkdirSync(endpathname)

        fs.writeFileSync(endpathname + '/manifest.json', header + " manifest\n" + obj.api.manifest)
        fs.writeFileSync(endpathname + '/main.js', header + " code\n" + obj.api.code)
        if(!fs.existsSync(endpathname + "/routes")) fs.mkdirSync(endpathname + "/routes")
        if(!fs.existsSync(endpathname + "/scripts")) fs.mkdirSync(endpathname + "/scripts")
        if(!fs.existsSync(endpathname + "/tests")) fs.mkdirSync(endpathname + "/tests")
        _.each(obj.api_routes, function (route) {
          header = "#FASTY " + route.id
          fs.writeFileSync(endpathname + '/routes/' + route.name + '.js', header + " javascript\n" + route.js)
        })
        _.each(obj.api_scripts, function (script) {
          header = "#FASTY " + script.id
          fs.writeFileSync(endpathname + '/scripts/' + script.name + '.js', header + " javascript\n" + script.js)
        })
        _.each(obj.api_tests, function (test) {
          header = "#FASTY " + test.id
          fs.writeFileSync(endpathname + '/tests/' + test.name + '.js', header + " javascript\n" + test.js)
        })
      }
      if (k == "scripts") {
        fs.writeFileSync(endpathname + '/index.js', header + " code\n" + obj.code)
        fs.writeFileSync(endpathname + '/package.json', header + " package\n" + obj.package)
      }
      if (k == "datasets") {
        header = "#FASTY " + obj._key
        _.each(_.keys(obj), function(n) {
          if(!_.includes(['_key', '_id', 'name', 'title', 'slug'], n)) {
            var type = ''
            if(_.includes(['js', 'javascript'], n)) { type = 'js' }
            if(type == '') type = n
            fs.writeFileSync(endpathname + '/' + type + '.' + type, header + " "+ n +"\n" + obj[n])
          }
        })
      }
    })
  })

  if(argv.w) {
    console.log("Watching folder.", dirname + '/fs/'+folder)
    chokidar.watch(dirname + '/fs/'+folder, {ignored: /(^|[\/\\])\../}).on('all', (event, path) => {
      if(event == "add") {
        console.log(`Added : ${path}`.cyan)
      }
      if(event == "change") {
        console.log(`Modifying : ${path}`.magenta.italic)
        setTimeout(function() {
          fs.readFile(path, function(err, data) {
            if (data.length > 0) {

              var url = domain + "/sync/" + token
              var params = {
                url: url,
                body: JSON.stringify({
                  data: data.toString(),
                  name: fullname
                })
              }
              request.patch(params, function optionalCallback(_err, _httpResponse, body) {
                console.log(body.green)
                notifier.notify("Fasty :: " + body)
              })
            } else {
              console.log('something went wrong ... please try again'.red)
            }
          })
        }, 100)
      }
    })
  }
}

if(argv._.length != 1) {
  console.log("usage : fasty <shortuct> -w".yellow)
} else {
  var fullname = tokens['name']
  var domain = tokens['domains'][argv._[0]].domain
  var token  = tokens['domains'][argv._[0]].token
  var folder = argv._[0]

  if(token === undefined) {
    console.log("Token not found for this domain".red)
    process.exit()
  }

  var url = domain + "/sync/" + token

  if(!fs.existsSync('fs')) fs.mkdirSync('fs')
  if(!fs.existsSync('fs/'+ folder)) fs.mkdirSync('fs/' + folder)

  if(argv.w) {
    console.log("Fetching data ...".green)
    request(url, function (_error, _response, body) {
      var data = JSON.parse(body)
      check_json(data, folder, fullname, domain)
    })
  }

  /*
  if(argv.c && argv.f) {
    var url = domain + "/api/create/?token=" + token

    request.post({
      url: url,
      formData: {
        type: argv.c,
        name: argv.f,
        fullname: fullname
      }
    }, function optionalCallback(err, httpResponse, body) {
      var url = 'http://' + domain + "/api/filenames/?token=" + token + '&type=' + argv.c + '&id=' + body
      console.log(body)
      notifier.notify("SoliCMS :: File Create !")
      console.log("Fetching data ...".green)
      request(url, function (error, response, body2) {
        console.log(body2)
        var data = JSON.parse(body2) // Print the HTML for the Google homepage.
        check_json(data, domain)
      })
    })
  }*/

}


